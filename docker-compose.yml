# -----------------------------
# СЕТИ И ТОМA
# -----------------------------
networks:
  wt-net:
    name: ${NETWORK_NAME:-wt-net}
    driver: bridge

volumes:
  redis-data:
  loki-data:
  logstash-data:
  promtail-positions:
  # для Postgres и Grafana монтируются по профилям
  postgres-data:
  grafana-data:

# -----------------------------
# СЕРВИСЫ 
# -----------------------------
services:

  # === EDGE / REVERSE PROXY ===
  nginx-proxy:
    image: ${IMAGE_NGINX}
    restart: always
    ports:
      - "80:80"
      - "${NGINX_WT_PORT_HTTP__WORKER:-81}:${NGINX_WT_PORT_HTTP__WORKER:-81}"
      - "443:443"
    environment:
      # DNS резолвер для FQDN (Dev в Docker: 127.0.0.11; Prod можно задать свой)
      NGINX_RESOLVER: ${NGINX_RESOLVER}

      # домены
      PUBLIC_FQDN__WEB: ${PUBLIC_FQDN__WEB}

      # сертификаты (в этом варианте используем WT‑сертификат для всех трёх серверов)
      NGINX_CERT_WT_CRT: ${NGINX_CERT_WT_CRT}
      NGINX_CERT_WT_KEY: ${NGINX_CERT_WT_KEY}

      # поведение прокси
      NGINX_ENABLE_GZIP: ${NGINX_ENABLE_GZIP}
      NGINX_PROXY_READ_TIMEOUT: ${NGINX_PROXY_READ_TIMEOUT}
      NGINX_PROXY_SEND_TIMEOUT: ${NGINX_PROXY_SEND_TIMEOUT}
      NGINX_PROXY_CONNECT_TIMEOUT: ${NGINX_PROXY_CONNECT_TIMEOUT}
      NGINX_PROXY_BUFFERING: ${NGINX_PROXY_BUFFERING}

      # upstream web (стратегия/keepalive/пассивные HC)
      NGINX_UPSTREAM_STRATEGY__WEB: ${NGINX_UPSTREAM_STRATEGY__WEB}
      NGINX_UPSTREAM_KEEPALIVE__WEB: ${NGINX_UPSTREAM_KEEPALIVE__WEB}
      NGINX_UPSTREAM_KEEPALIVE__WORKER: ${NGINX_UPSTREAM_KEEPALIVE__WORKER}
      NGINX_UPSTREAM_KEEPALIVE__VCLASS: ${NGINX_UPSTREAM_KEEPALIVE__VCLASS}
      NGINX_UPSTREAM_KEEPALIVE__RECORDER: ${NGINX_UPSTREAM_KEEPALIVE__RECORDER}
      NGINX_UPSTREAM_MAX_FAILS: ${NGINX_UPSTREAM_MAX_FAILS}
      NGINX_UPSTREAM_FAIL_TIMEOUT: ${NGINX_UPSTREAM_FAIL_TIMEOUT}

      # HSTS
      NGINX_HSTS_MAX_AGE: ${NGINX_HSTS_MAX_AGE}

      # worker http‑порт/ограничение
      NGINX_WT_PORT_HTTP__WORKER: ${NGINX_WT_PORT_HTTP__WORKER}

      # цели upstream'ов
      UPSTREAM_HOST_NAME__WEB_1: ${UPSTREAM_HOST_NAME__WEB_1}
      UPSTREAM_HOST_PORT__WEB_1: ${UPSTREAM_HOST_PORT__WEB_1}
      UPSTREAM_HOST_NAME__WEB_2: ${UPSTREAM_HOST_NAME__WEB_2}
      UPSTREAM_HOST_PORT__WEB_2: ${UPSTREAM_HOST_PORT__WEB_2}
      UPSTREAM_HOST_NAME__WORKER: ${UPSTREAM_HOST_NAME__WORKER}
      UPSTREAM_HOST_PORT__WORKER: ${UPSTREAM_HOST_PORT__WORKER}
    volumes:
      # шаблоны
      - ./nginx-proxy/nginx.conf.template:/etc/nginx/nginx.conf.template:ro
      # скрипт рендеринга — попадёт в /docker-entrypoint.d/ и выполнится автоматически
      - ./nginx-proxy/init-nginx.sh:/docker-entrypoint.d/50-init-nginx.sh:ro
      # сертификаты
      - ${WT_CERTS_DIR}:/etc/nginx/certs:ro
    depends_on:
      web-backend-1:
        condition: service_started
      web-backend-2:
        condition: service_started
      worker-backend:
        condition: service_started
    networks: [wt-net]

  # === REDIS (кэш/очереди WT) ===
  redis:
    image: ${IMAGE_REDIS}
    restart: always
    environment:
      REDIS_PASSWORD: ${PASSWORD__REDIS}
    volumes:
      - redis-data:/data
    command: ["redis-server","--appendonly","yes","--requirepass","${PASSWORD__REDIS}"]
    healthcheck:
      test: ["CMD","redis-cli","-a","${PASSWORD__REDIS}","PING"]
      interval: ${HC_INTERVAL__REDIS:-5s}
      timeout: ${HC_TIMEOUT__REDIS:-3s}
      retries: ${HC_RETRIES__REDIS:-5}
    networks: [wt-net]

  # === WEB НОДА №1 ===
  web-backend-1:
    image: ${IMAGE_WT}
    hostname: wt_dev
    platform: linux/amd64
    restart: always
    command: ["/bin/sh","-lc","/WebsoftServer/wait-pg.sh && /WebsoftServer/init-spxml.sh && exec /WebsoftServer/xhttp.out"]
    environment:
      NodesPoolId: "1"
      ExternalDeployment: "true"
      MEMORY_MIMALLOC: "2"
      RoleType: "0"
      # PG WAIT
      PG_WAIT_ENABLED: ${PG_WAIT_ENABLED}
      PG_WAIT_DEADLINE: ${PG_WAIT_DEADLINE}
      PG_WAIT_INTERVAL: ${PG_WAIT_INTERVAL}
      PG_WAIT_ON_TIMEOUT: ${PG_WAIT_ON_TIMEOUT}
      # ====== SPXML (WEB) — роли/кластер/кэш/ComplexHosting ======
      SPXML_CONF_SESSION_EXPIRATION:              ${SPXML_CONF_SESSION_EXPIRATION__WEB}
      SPXML_CONF_MAX_SESSIONS_COUNT:              ${SPXML_CONF_MAX_SESSIONS_COUNT__WEB}
      SPXML_CONF_MAX_FT_DOCS:                     ${SPXML_CONF_MAX_FT_DOCS__WEB}
      SPXML_CONF_UPGRADE_LOCKED:                  ${SPXML_CONF_UPGRADE_LOCKED__WEB}
      SPXML_CONF_IN_PLACE_UPGRADE:                ${SPXML_CONF_IN_PLACE_UPGRADE__WEB}
      SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE:   ${SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE__WEB}
      SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES:    ${SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES__WEB}
      SPXML_CONF_LOCAL_OBJECT_CLIENT_CACHE:       ${SPXML_CONF_LOCAL_OBJECT_CLIENT_CACHE__WEB}
      SPXML_CONF_LOCAL_OBJECT_CACHE:              ${SPXML_CONF_LOCAL_OBJECT_CACHE__WEB}
      SPXML_CONF_LOCAL_FILE_CACHE:                ${SPXML_CONF_LOCAL_FILE_CACHE__WEB}
      SPXML_CONF_LUCENE_FT_CACHE:                 ${SPXML_CONF_LUCENE_FT_CACHE__WEB}
      SPXML_CONF_LUCENE_FT_INDEX_RAM_BUFFER_SIZE: ${SPXML_CONF_LUCENE_FT_INDEX_RAM_BUFFER_SIZE__WEB}

      SPXML_CONF_STRICT_WEBROLE:                  ${SPXML_CONF_STRICT_WEBROLE__WEB}
      SPXML_CONF_STRICT_WORKERROLE:               ${SPXML_CONF_STRICT_WORKERROLE__WEB}
      SPXML_CONF_STRICT_ROLE_TYPES:               ${SPXML_CONF_STRICT_ROLE_TYPES__WEB}
      SPXML_CONF_REDIS_MAXMEMORY_ITEM_BYTES:      ${SPXML_CONF_REDIS_MAXMEMORY_ITEM_BYTES}

      SPXML_CONF_COMPLEX_HOSTING_BLOCK:           ${SPXML_CONF_COMPLEX_HOSTING_BLOCK__WEB}

      # ====== Подстановки для шаблона SPXML: БД и Redis (нужны и на WEB) ======
      HOST_NAME__PG:                              ${HOST_NAME__PG}
      HOST_PORT__PG:                              ${HOST_PORT__PG}
      DB_NAME__PG:                                ${DB_NAME__PG}
      DB_USER__PG:                                ${DB_USER__PG}
      DB_PASSWORD__PG:                            ${DB_PASSWORD__PG}

      HOST_NAME__REDIS:                           ${HOST_NAME__REDIS}
      HOST_PORT__REDIS:                           ${HOST_PORT__REDIS}
      PASSWORD__REDIS:                            ${PASSWORD__REDIS}
      OPTS__REDIS:                                ${OPTS__REDIS}
      # ====== для OmniCode ======
      WebTutorServerDir: ${WEBTUTOR_SERVER_DIR}
      DebugWebTutorServerDir: ${DEBUG_WEBTUTOR_SERVER_DIR}
      DefaultNetCoreTargetFramework: ${DEFAULT_NETCORE_TARGET_FRAMEWORK}
      DefaultNetStandardTargetFramework: ${DEFAULT_NETSTANDARD_TARGET_FRAMEWORK}
      WEBSOFT_MSBUILD_SDK_PATH: ${WEBSOFT_MSBUILD_SDK_PATH}
    volumes:
      # Конфиги WebSoft
      - ./websoft/configs/common/license.xfpx:/WebsoftServer/license.xfpx:ro
      - ./websoft/configs/common/resource_sec.json:/WebsoftServer/resource_sec.json
      - ./websoft/configs/common/xHttp.ini:/WebsoftServer/xHttp.ini
      - ./websoft/configs/web-backend/xhttp_config.json:/WebsoftServer/xhttp_config.json
      # шаблоны и скрипты инициализации конфигов
      - ./websoft/configs/common/spxml_unibridge_config.xml.template:/WebsoftServer/configs/spxml_unibridge_config.xml.template:ro
      - ./websoft/configs/common/init-spxml.sh:/WebsoftServer/init-spxml.sh:ro
      - ./websoft/configs/common/wait-pg.sh:/WebsoftServer/wait-pg.sh:ro
      # Рантайм каталоги
      - ./websoft/ft-idx:/WebsoftServer/ft-idx
      - ./websoft/wt_data:/WebsoftServer/wt_data
      - ./websoft/web/webtutor:/WebsoftServer/wt/web/webtutor
      - ./websoft/runtimes/web-backend/platform:/WebsoftServer/platform.runtime
      - ./websoft/runtimes/web-backend/components:/WebsoftServer/components.runtime
      # Логи 
      - ./websoft/Logs/web-backend-1:/WebsoftServer/Logs
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL","wget -q --spider http://localhost:8011/spxml_web/main.htm || exit 1"]
      interval: ${HC_INTERVAL__WEB:-10s}
      timeout: ${HC_TIMEOUT__WEB:-5s}
      start_period: ${HC_START_PERIOD__WEB:-90s}
      retries: ${HC_RETRIES__WEB:-12}
    networks: [wt-net]

  # === WEB НОДА №2 ===
  web-backend-2:
    image: ${IMAGE_WT}
    hostname: wt_dev
    platform: linux/amd64
    restart: always
    command: ["/bin/sh","-lc","/WebsoftServer/wait-pg.sh && /WebsoftServer/init-spxml.sh && exec /WebsoftServer/xhttp.out"]
    environment:
      NodesPoolId: "1"
      ExternalDeployment: "true"
      MEMORY_MIMALLOC: "2"
      RoleType: "0"
      # PG WAIT
      PG_WAIT_ENABLED: ${PG_WAIT_ENABLED}
      PG_WAIT_DEADLINE: ${PG_WAIT_DEADLINE}
      PG_WAIT_INTERVAL: ${PG_WAIT_INTERVAL}
      PG_WAIT_ON_TIMEOUT: ${PG_WAIT_ON_TIMEOUT}
      # ====== SPXML (WEB) — роли/кластер/кэш/ComplexHosting ======
      SPXML_CONF_SESSION_EXPIRATION:              ${SPXML_CONF_SESSION_EXPIRATION__WEB}
      SPXML_CONF_MAX_SESSIONS_COUNT:              ${SPXML_CONF_MAX_SESSIONS_COUNT__WEB}
      SPXML_CONF_MAX_FT_DOCS:                     ${SPXML_CONF_MAX_FT_DOCS__WEB}
      SPXML_CONF_UPGRADE_LOCKED:                  ${SPXML_CONF_UPGRADE_LOCKED__WEB}
      SPXML_CONF_IN_PLACE_UPGRADE:                ${SPXML_CONF_IN_PLACE_UPGRADE__WEB}
      SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE:   ${SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE__WEB}
      SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES:    ${SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES__WEB}
      SPXML_CONF_LOCAL_OBJECT_CLIENT_CACHE:       ${SPXML_CONF_LOCAL_OBJECT_CLIENT_CACHE__WEB}
      SPXML_CONF_LOCAL_OBJECT_CACHE:              ${SPXML_CONF_LOCAL_OBJECT_CACHE__WEB}
      SPXML_CONF_LOCAL_FILE_CACHE:                ${SPXML_CONF_LOCAL_FILE_CACHE__WEB}
      SPXML_CONF_LUCENE_FT_CACHE:                 ${SPXML_CONF_LUCENE_FT_CACHE__WEB}
      SPXML_CONF_LUCENE_FT_INDEX_RAM_BUFFER_SIZE: ${SPXML_CONF_LUCENE_FT_INDEX_RAM_BUFFER_SIZE__WEB}

      SPXML_CONF_STRICT_WEBROLE:                  ${SPXML_CONF_STRICT_WEBROLE__WEB}
      SPXML_CONF_STRICT_WORKERROLE:               ${SPXML_CONF_STRICT_WORKERROLE__WEB}
      SPXML_CONF_STRICT_ROLE_TYPES:               ${SPXML_CONF_STRICT_ROLE_TYPES__WEB}
      SPXML_CONF_REDIS_MAXMEMORY_ITEM_BYTES:      ${SPXML_CONF_REDIS_MAXMEMORY_ITEM_BYTES}

      SPXML_CONF_COMPLEX_HOSTING_BLOCK:           ${SPXML_CONF_COMPLEX_HOSTING_BLOCK__WEB}

      # ====== Подстановки для шаблона SPXML: БД и Redis (нужны и на WEB) ======
      HOST_NAME__PG:                              ${HOST_NAME__PG}
      HOST_PORT__PG:                              ${HOST_PORT__PG}
      DB_NAME__PG:                                ${DB_NAME__PG}
      DB_USER__PG:                                ${DB_USER__PG}
      DB_PASSWORD__PG:                            ${DB_PASSWORD__PG}

      HOST_NAME__REDIS:                           ${HOST_NAME__REDIS}
      HOST_PORT__REDIS:                           ${HOST_PORT__REDIS}
      PASSWORD__REDIS:                            ${PASSWORD__REDIS}
      OPTS__REDIS:                                ${OPTS__REDIS}
      # ====== для OmniCode ======
      WebTutorServerDir: ${WEBTUTOR_SERVER_DIR}
      DebugWebTutorServerDir: ${DEBUG_WEBTUTOR_SERVER_DIR}
      DefaultNetCoreTargetFramework: ${DEFAULT_NETCORE_TARGET_FRAMEWORK}
      DefaultNetStandardTargetFramework: ${DEFAULT_NETSTANDARD_TARGET_FRAMEWORK}
      WEBSOFT_MSBUILD_SDK_PATH: ${WEBSOFT_MSBUILD_SDK_PATH}
    volumes:
      # Конфиги WebSoft
      - ./websoft/configs/common/license.xfpx:/WebsoftServer/license.xfpx:ro
      - ./websoft/configs/common/resource_sec.json:/WebsoftServer/resource_sec.json
      - ./websoft/configs/common/xHttp.ini:/WebsoftServer/xHttp.ini
      - ./websoft/configs/web-backend/xhttp_config.json:/WebsoftServer/xhttp_config.json
      # шаблоны и скрипты инициализации конфигов
      - ./websoft/configs/common/spxml_unibridge_config.xml.template:/WebsoftServer/configs/spxml_unibridge_config.xml.template:ro
      - ./websoft/configs/common/init-spxml.sh:/WebsoftServer/init-spxml.sh:ro
      - ./websoft/configs/common/wait-pg.sh:/WebsoftServer/wait-pg.sh:ro
      # Рантайм каталоги
      - ./websoft/ft-idx:/WebsoftServer/ft-idx
      - ./websoft/wt_data:/WebsoftServer/wt_data
      - ./websoft/web/webtutor:/WebsoftServer/wt/web/webtutor
      - ./websoft/runtimes/web-backend/platform:/WebsoftServer/platform.runtime
      - ./websoft/runtimes/web-backend/components:/WebsoftServer/components.runtime
      # Логи 
      - ./websoft/Logs/web-backend-2:/WebsoftServer/Logs
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL","wget -q --spider http://localhost:8011/spxml_web/main.htm || exit 1"]
      interval: ${HC_INTERVAL__WEB:-10s}
      timeout: ${HC_TIMEOUT__WEB:-5s}
      start_period: ${HC_START_PERIOD__WEB:-90s}
      retries: ${HC_RETRIES__WEB:-12}
    networks: [wt-net]
  
  # === WORKER НОДА ===
  worker-backend:
    image: ${IMAGE_WT}
    hostname: wt_dev
    platform: linux/amd64
    restart: always
    command: ["/bin/sh","-lc","/WebsoftServer/wait-pg.sh && /WebsoftServer/init-spxml.sh && exec /WebsoftServer/xhttp.out"]
    environment:
      NodesPoolId: "3"
      ExternalDeployment: "true"
      MEMORY_MIMALLOC: "2"
      RoleType: "1"
      # PG WAIT
      PG_WAIT_ENABLED: ${PG_WAIT_ENABLED}
      PG_WAIT_DEADLINE: ${PG_WAIT_DEADLINE}
      PG_WAIT_INTERVAL: ${PG_WAIT_INTERVAL}
      PG_WAIT_ON_TIMEOUT: ${PG_WAIT_ON_TIMEOUT}
      # ====== SPXML (WORKER) — роли/кластер/кэш/ComplexHosting ======
      SPXML_CONF_SESSION_EXPIRATION:              ${SPXML_CONF_SESSION_EXPIRATION__WORKER}
      SPXML_CONF_MAX_SESSIONS_COUNT:              ${SPXML_CONF_MAX_SESSIONS_COUNT__WORKER}
      SPXML_CONF_MAX_FT_DOCS:                     ${SPXML_CONF_MAX_FT_DOCS__WORKER}
      SPXML_CONF_UPGRADE_LOCKED:                  ${SPXML_CONF_UPGRADE_LOCKED__WORKER}
      SPXML_CONF_IN_PLACE_UPGRADE:                ${SPXML_CONF_IN_PLACE_UPGRADE__WORKER}
      SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE:   ${SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE__WORKER}
      SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES:    ${SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES__WORKER}
      SPXML_CONF_LOCAL_OBJECT_CLIENT_CACHE:       ${SPXML_CONF_LOCAL_OBJECT_CLIENT_CACHE__WORKER}
      SPXML_CONF_LOCAL_OBJECT_CACHE:              ${SPXML_CONF_LOCAL_OBJECT_CACHE__WORKER}
      SPXML_CONF_LOCAL_FILE_CACHE:                ${SPXML_CONF_LOCAL_FILE_CACHE__WORKER}
      SPXML_CONF_LUCENE_FT_CACHE:                 ${SPXML_CONF_LUCENE_FT_CACHE__WORKER}
      SPXML_CONF_LUCENE_FT_INDEX_RAM_BUFFER_SIZE: ${SPXML_CONF_LUCENE_FT_INDEX_RAM_BUFFER_SIZE__WORKER}

      SPXML_CONF_STRICT_WEBROLE:                  ${SPXML_CONF_STRICT_WEBROLE__WORKER}
      SPXML_CONF_STRICT_WORKERROLE:               ${SPXML_CONF_STRICT_WORKERROLE__WORKER}
      SPXML_CONF_STRICT_ROLE_TYPES:               ${SPXML_CONF_STRICT_ROLE_TYPES__WORKER}
      SPXML_CONF_REDIS_MAXMEMORY_ITEM_BYTES:      ${SPXML_CONF_REDIS_MAXMEMORY_ITEM_BYTES}

      SPXML_CONF_COMPLEX_HOSTING_BLOCK:           ${SPXML_CONF_COMPLEX_HOSTING_BLOCK__WORKER}

      # ====== Подстановки для шаблона SPXML: БД и Redis (нужны и на WEB) ======
      HOST_NAME__PG:                              ${HOST_NAME__PG}
      HOST_PORT__PG:                              ${HOST_PORT__PG}
      DB_NAME__PG:                                ${DB_NAME__PG}
      DB_USER__PG:                                ${DB_USER__PG}
      DB_PASSWORD__PG:                            ${DB_PASSWORD__PG}

      HOST_NAME__REDIS:                           ${HOST_NAME__REDIS}
      HOST_PORT__REDIS:                           ${HOST_PORT__REDIS}
      PASSWORD__REDIS:                            ${PASSWORD__REDIS}
      OPTS__REDIS:                                ${OPTS__REDIS}
      # ====== для OmniCode ======
      WebTutorServerDir: ${WEBTUTOR_SERVER_DIR}
      DebugWebTutorServerDir: ${DEBUG_WEBTUTOR_SERVER_DIR}
      DefaultNetCoreTargetFramework: ${DEFAULT_NETCORE_TARGET_FRAMEWORK}
      DefaultNetStandardTargetFramework: ${DEFAULT_NETSTANDARD_TARGET_FRAMEWORK}
      WEBSOFT_MSBUILD_SDK_PATH: ${WEBSOFT_MSBUILD_SDK_PATH}
    volumes:
      # Конфиги WebSoft
      - ./websoft/configs/common/license.xfpx:/WebsoftServer/license.xfpx:ro
      - ./websoft/configs/common/resource_sec.json:/WebsoftServer/resource_sec.json
      - ./websoft/configs/common/xHttp.ini:/WebsoftServer/xHttp.ini
      - ./websoft/configs/worker-backend/xhttp_config.json:/WebsoftServer/xhttp_config.json
      # шаблоны и скрипты инициализации конфигов
      - ./websoft/configs/common/spxml_unibridge_config.xml.template:/WebsoftServer/configs/spxml_unibridge_config.xml.template:ro
      - ./websoft/configs/common/init-spxml.sh:/WebsoftServer/init-spxml.sh:ro
      - ./websoft/configs/common/wait-pg.sh:/WebsoftServer/wait-pg.sh:ro
      # Рантайм каталоги
      - ./websoft/ft-idx:/WebsoftServer/ft-idx
      - ./websoft/wt_data:/WebsoftServer/wt_data
      - ./websoft/web/webtutor:/WebsoftServer/wt/web/webtutor
      - ./websoft/runtimes/worker-backend/platform:/WebsoftServer/platform.runtime
      - ./websoft/runtimes/worker-backend/components:/WebsoftServer/components.runtime
      # Логи 
      - ./websoft/Logs/worker-backend:/WebsoftServer/Logs
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL","wget -q --spider http://localhost:8011/spxml_web/main.htm || exit 1"]
      interval: ${HC_INTERVAL__WORKER:-10s}
      timeout: ${HC_TIMEOUT__WORKER:-5s}
      start_period: ${HC_START_PERIOD__WORKER:-90s}
      retries: ${HC_RETRIES__WORKER:-12}
    networks: [wt-net]


  loki:
    image: ${IMAGE_LOKI}
    user: root
    environment:
      LOKI_RETENTION_PERIOD: ${LOKI_RETENTION_PERIOD}
      LOKI_REJECT_OLD_SAMPLES_MAX_AGE: ${LOKI_REJECT_OLD_SAMPLES_MAX_AGE}
      LOKI_MAX_LOOK_BACK_PERIOD: ${LOKI_MAX_LOOK_BACK_PERIOD}
      LOKI_CHUNK_IDLE_PERIOD: ${LOKI_CHUNK_IDLE_PERIOD}
      LOKI_MAX_CHUNK_AGE: ${LOKI_MAX_CHUNK_AGE}
      LOKI_CHUNK_RETAIN_PERIOD: ${LOKI_CHUNK_RETAIN_PERIOD}
      HOST_PORT__LOKI: ${HOST_PORT__LOKI}
    ports:
      - "${HOST_PORT__LOKI}:${HOST_PORT__LOKI}"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://localhost:${HOST_PORT__LOKI}/ready | grep -q ready"]
      interval: 5s
      timeout: 3s
      retries: 30
    command: -config.file=/etc/loki/config.yaml -config.expand-env=true
    volumes:
      - ./monitoring/loki/loki-config.yaml:/etc/loki/config.yaml
      - loki-data:/loki
    networks:
      - wt-net

  promtail:
    image: ${IMAGE_PROMTAIL}
    restart: always
    user: "0"                           # чтобы мог читать маунты (RO)
    command: -config.file=/etc/promtail/promtail.yml -config.expand-env=true
    environment:
      # Лейблы/переменные
      LOKI_JOB_LABEL: ${LOKI_JOB_LABEL}
      ENV_FALLBACK: ${ENV_FALLBACK}
      LOKI_HOST: ${HOST_NAME__LOKI}
      LOKI_PORT: ${HOST_PORT__LOKI}
      PROMTAIL_TIMEZONE: ${TZ}
      PROMTAIL_MULTILINE_FIRSTLINE: ${PROMTAIL_MULTILINE_FIRSTLINE}
      PROMTAIL_MULTILINE_MAX_WAIT_TIME: ${PROMTAIL_MULTILINE_MAX_WAIT_TIME}
    volumes:
      # конфиг промтейла
      - ./monitoring/promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      # состояние "прочитанных смещений"
      - promtail-positions:/positions
      # те же логи, что и раньше (RO)
      - ./websoft/Logs/web-backend-1:/var/log/wt/web-backend-1:ro
      - ./websoft/Logs/web-backend-2:/var/log/wt/web-backend-2:ro
      - ./websoft/Logs/worker-backend:/var/log/wt/worker-backend:ro
      # если у тебя будет сетевая шара, просто смонтируй её в ./websoft/Logs/shared и добавь ещё один маунт:
      # - ./websoft/Logs/shared:/var/log/wt/shared:ro
    depends_on:
      loki:
        condition: service_healthy
    networks: [wt-net]
  
  # ====================================================
  #  MONITORING
  # ====================================================
  # --- сервис может читать из S3 и шлёт в Loki ---
  grafana:
    profiles: ["local-grafana"]
    image: ${IMAGE_GRAFANA}
    restart: always
    ports:
      - "${HOST_PORT__GRAFANA}:${HOST_PORT__GRAFANA}"
    environment:
      TZ: ${TZ}
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: ${GF_USERS_ALLOW_SIGN_UP}
      # удобно, чтобы Grafana знала собственный адрес (для callback-ов/ссылок)
      GF_SERVER_DOMAIN: "localhost"
      GF_SERVER_ROOT_URL: "http://localhost:${HOST_PORT__GRAFANA}"
      # включи аноним, если хочешь быстро зайти без логина
      # GF_AUTH_ANONYMOUS_ENABLED: "true"
      # GF_AUTH_ANONYMOUS_ORG_ROLE: "Viewer"
    volumes:
      - grafana-data:/var/lib/grafana
      # автопровиженинг датасорсов/дашбордов (по желанию — если у тебя есть эти каталоги)
      - ./monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      loki:
        condition: service_started
    networks: [wt-net]
  
  postgres:
    profiles: ["local-postgres"]
    image: ${IMAGE_POSTGRES}
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER__PG}
      POSTGRES_PASSWORD: ${DB_PASSWORD__PG}
      POSTGRES_DB: ${DB_NAME__PG}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER__PG} -d ${DB_NAME__PG} -h localhost"]
      interval: ${HC_INTERVAL__PG:-5s}
      timeout: ${HC_TIMEOUT__PG:-10s}
      retries: ${HC_RETRIES__PG:-10}
    networks: [wt-net]
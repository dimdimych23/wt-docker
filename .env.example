###############################################################################
#                          PROJECT / NETWORK / TIME                           #
###############################################################################
PROJECT_NAME=wt-docker
COMPOSE_PROJECT_NAME=wt-docker
NETWORK_NAME=wt-net
TZ=Europe/Moscow

###############################################################################
#                               NGINX / CERTS                                 #
###############################################################################
NGINX_IMAGE=nginx:1.25-alpine
# Каталог с сертификатами, монтируется внутрь контейнера Nginx как /etc/nginx/certs
WT_CERTS_DIR=./certs/wt

# Общий сертификат (удобно для dev; для prod можно разнести по доменам ниже)
NGINX_CERT_WT_CRT=wt+2.pem
NGINX_CERT_WT_KEY=wt+2-key.pem

###############################################################################
#                           NGINX HOSTS / PUBLIC PORTS                        #
###############################################################################
# Внешние DNS-имена (совпадают с сертификатами)
PUBLIC_FQDN__WEB=wt.local
PUBLIC_FQDN__VCLASS_MEDIA=wt-vclass.local
PUBLIC_FQDN__VCLASS_RECORDER=wt-recorder.local


# Порты, которые слушает Nginx на хосте 
# (80/443 — по умолчанию; 81 — для доступа к worker)
NGINX_WT_PORT_HTTP__WORKER=81          # локальный HTTP-доступ до worker через Nginx (удобно для dev)

###############################################################################
#                      UPSTREAMS (ВНУТРИ — ТОЛЬКО HTTP)                       #
###############################################################################
# Основной WebSoft HCM (до 4 нод). Для dev — имена docker-сервисов; для prod — FQDN/IP.
UPSTREAM_HOST_NAME__WEB_1=web-backend-1
UPSTREAM_HOST_PORT__WEB_1=8011
UPSTREAM_HOST_NAME__WEB_2=web-backend-2
UPSTREAM_HOST_PORT__WEB_2=8011

# Worker (обычно одна нода)
UPSTREAM_HOST_NAME__WORKER=worker-backend
UPSTREAM_HOST_PORT__WORKER=8011

###############################################################################
#                       NGINX — ПОВЕДЕНИЕ/ОПТИМИЗАЦИЯ                         #
###############################################################################

# resolver DNS для FQDN (Docker: 127.0.0.11).
NGINX_RESOLVER=127.0.0.11

# Балансировка web-бекенда: round_robin (по умолчанию в nginx), least_conn, ip_hash
NGINX_UPSTREAM_STRATEGY__WEB=least_conn

# Тонкая настройка по апстримам 
NGINX_UPSTREAM_KEEPALIVE__WEB=32
NGINX_UPSTREAM_KEEPALIVE__WORKER=32
NGINX_UPSTREAM_KEEPALIVE__VCLASS=32
NGINX_UPSTREAM_KEEPALIVE__RECORDER=32

# Пассивные health‑checks для членов upstream
NGINX_UPSTREAM_MAX_FAILS=5
NGINX_UPSTREAM_FAIL_TIMEOUT=30s

# Таймауты/буферы обратного прокси
NGINX_PROXY_READ_TIMEOUT=3600s
NGINX_PROXY_SEND_TIMEOUT=3600s
NGINX_PROXY_CONNECT_TIMEOUT=10s
NGINX_PROXY_BUFFERING=off

# Gzip
NGINX_ENABLE_GZIP=on

# HSTS (включать в prod, когда действительно весь трафик — только по HTTPS)
NGINX_HSTS_MAX_AGE=31536000

###############################################################################
#                                  POSTGRESQL                                 #
###############################################################################
PG_IMAGE=postgres:16
HOST_NAME__PG=postgres
HOST_PORT__PG=5432
DB_NAME__PG=wt
DB_USER__PG=wt
DB_PASSWORD__PG=wt_password                         # либо DB_PASSWORD__PG_FILE=/run/secrets/DB_PASSWORD__PG

# UI
PGADMIN_DEFAULT_EMAIL=admin@local.com
PGADMIN_DEFAULT_PASSWORD=DB_PASSWORD__PG            # либо файл-секрет

###############################################################################
#                                    REDIS                                    #
###############################################################################
REDIS_IMAGE=redis:7.2-alpine
HOST_NAME__REDIS=redis
HOST_PORT__REDIS=6379
PASSWORD__REDIS=super_secret_password
OPTS__REDIS=abortConnect=false, allowAdmin=true, connectTimeout=5000, keepAlive=10, syncTimeout=1000


###############################################################################
#                               WEBSoft / LOGS / VFS                          #
###############################################################################
WT_IMAGE=${WT_IMAGE}

# Логи: поведение
LOG_MIN_CHECK_INTERVAL=5
LOG_CONSOLIDATION=true
LOG_CONSOLIDATE_CHECK_INTERVAL=60
LOG_FULL_CONSOLIDATION=true

VFS_LOOK_ON_LOCAL=true
VFS_FETCH_BACK=true
VFS_DELETE_LOCAL_AFTER_FETCH=false

###############################################################################
#                   Websoft HCM spxml_unibridge_config.xml                    #
###############################################################################
# Redis cache
SPXML_CONF_REDIS_MAXMEMORY_ITEM_BYTES=338860800

# ==== SPXML (WEB role) ====
SPXML_CONF_SESSION_EXPIRATION__WEB=3600
SPXML_CONF_MAX_SESSIONS_COUNT__WEB=1000
SPXML_CONF_MAX_FT_DOCS__WEB=1000
SPXML_CONF_UPGRADE_LOCKED__WEB=true
SPXML_CONF_IN_PLACE_UPGRADE__WEB=true
SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE__WEB=20
SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES__WEB=
SPXML_CONF_LOCAL_OBJECT_CACHE__WEB=false
SPXML_CONF_LOCAL_FILE_CACHE__WEB=false

SPXML_CONF_STRICT_WEBROLE__WEB=true
SPXML_CONF_STRICT_WORKERROLE__WEB=false
SPXML_CONF_STRICT_ROLE_TYPES__WEB=WebsocketQueue,WebOnly
SPXML_CONF_COMPLEX_HOSTING_BLOCK__WEB='[{'Host':'wt.local','RoleTypes':['WebsocketQueue','WebOnly']}]'

# ==== SPXML (WORKER role) ====
SPXML_CONF_SESSION_EXPIRATION__WORKER=3600
SPXML_CONF_MAX_SESSIONS_COUNT__WORKER=200
SPXML_CONF_MAX_FT_DOCS__WORKER=5000
SPXML_CONF_UPGRADE_LOCKED__WORKER=false
SPXML_CONF_IN_PLACE_UPGRADE__WORKER=false
SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE__WORKER=20
SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES__WORKER=

SPXML_CONF_STRICT_WEBROLE__WORKER=false
SPXML_CONF_STRICT_WORKERROLE__WORKER=true
SPXML_CONF_STRICT_ROLE_TYPES__WORKER=Agent,Notification,ScriptQueue
SPXML_CONF_COMPLEX_HOSTING_BLOCK__WORKER='[]'

# ==== SPXML (VCLASS_MEDIA role) ====
SPXML_CONF_SESSION_EXPIRATION__VCLASS_MEDIA=3600
SPXML_CONF_MAX_SESSIONS_COUNT__VCLASS_MEDIA=1000
SPXML_CONF_MAX_FT_DOCS__VCLASS_MEDIA=1000
SPXML_CONF_UPGRADE_LOCKED__VCLASS_MEDIA=true
SPXML_CONF_IN_PLACE_UPGRADE__VCLASS_MEDIA=true
SPXML_CONF_REDIS_LIMIT_MEMORY_PERCENTAGE__VCLASS_MEDIA=20
SPXML_CONF_REDIS_LIMIT_MEMORY_MEGABYTES__VCLASS_MEDIA=
SPXML_CONF_LOCAL_OBJECT_CACHE__VCLASS_MEDIA=false
SPXML_CONF_LOCAL_FILE_CACHE__VCLASS_MEDIA=false

SPXML_CONF_STRICT_WEBROLE__VCLASS_MEDIA=true
SPXML_CONF_STRICT_WORKERROLE__VCLASS_MEDIA=false
SPXML_CONF_STRICT_ROLE_TYPES__VCLASS_MEDIA=MediaService
SPXML_CONF_COMPLEX_HOSTING_BLOCK__VCLASS_MEDIA='[{'Host':'wt-vclass.local','RoleTypes':['MediaService']}]'

###############################################################################
#                              MONITORING / LOKI                              #
###############################################################################
LOKI_SERVICE_URL=http://loki:3100
LOKI_JOB_LABEL=websoft-hcm
GF_SECURITY_ADMIN_USER=admin
GF_SECURITY_ADMIN_PASSWORD=gf_password            # либо GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_pass
GF_USERS_ALLOW_SIGN_UP=false
ROLE_FALLBACK=role_not_found
ENV_FALLBACK=env_not_found
LOG_TYPE_FALLBACK=log_type_not_found

###############################################################################
#                           HEALTHCHECK TIMINGS (opt)                          #
###############################################################################
HC_INTERVAL__WEB=10s
HC_TIMEOUT__WEB=5s
HC_START_PERIOD__WEB=90s
HC_RETRIES__WEB=12
HC_INTERVAL__WORKER=10s
HC_TIMEOUT__WORKER=5s
HC_START_PERIOD__WORKER=90s
HC_RETRIES__WORKER=12
HC_INTERVAL__PG=5s
HC_TIMEOUT__PG=10s
HC_RETRIES__PG=10
HC_INTERVAL__REDIS=5s
HC_TIMEOUT__REDIS=3s
HC_RETRIES__REDIS=5